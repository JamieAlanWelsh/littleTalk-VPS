{% extends "base.html" %}
{% block title %}School Dashboard{% endblock %}
{% load static %}

{% block content %}
<h1>{{ school_name }} â€“ Staff Dashboard</h1>

<div class="container-box container--wide">
    <div class="logbook-header">
        {% if can_invite_staff %}
            <a href="{% url 'invite_staff' %}" class="btn btn--yellow">+ Invite Staff</a>
        {% else %}
            <button class="btn btn--grey" disabled>+ Invite Staff</button>
        {% endif %}

        <a href="{% url 'cohort_list' %}" class="btn btn--white">Manage Cohorts</a>
    </div>
    
    <h3>Staff Members</h3>
    <div class="table-wrapper">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Last Login</th>
                </tr>
            </thead>
            <tbody>
                {% for profile in staff_profiles %}
                    <tr>
                        <td>{{ profile.first_name }}</td>
                        <td>{{ profile.user.email }}</td>
                        <td>
                            {% with current_user=request.user.profile %}
                                {% if current_user.is_admin or current_user.is_manager %}
                                    {% if profile.user != request.user and profile.role != 'admin' %}
                                        <form method="post" style="margin: 0;">
                                            {% csrf_token %}
                                            <input type="hidden" name="user_id" value="{{ profile.user.id }}">
                                            <select name="new_role" onchange="this.form.submit()">
                                                {% for value, label in role_choices %}
                                                    {% if current_user.is_admin or value != 'admin' %}
                                                        <option value="{{ value }}" {% if profile.role == value %}selected{% endif %}>
                                                            {{ label }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </form>
                                    {% else %}
                                        {{ profile.get_role_display }}
                                    {% endif %}
                                {% else %}
                                    {{ profile.get_role_display }}
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>{{ profile.user.last_login|default:"Never" }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h3 style="margin-top: 2em;">Pending Invites</h3>
    <div class="table-wrapper">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Sent By</th>
                    <th>Sent</th>
                    {% if can_invite_staff %}
                        <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for invite in invites %}
                    <tr>
                        <td>{{ invite.email }}</td>
                        <td>{{ invite.role|capfirst }}</td>
                        <td>{{ invite.sent_by.get_full_name|default:invite.sent_by.username }}</td>
                        <td>{{ invite.created_at|date:"M j, Y" }}</td>
                        {% if can_invite_staff %}
                            <td>
                                <form method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="invite_id" value="{{ invite.id }}">
                                    <button type="submit" name="resend_invite" class="btn btn--white small-btn">Resend</button>
                                    <button type="submit" name="withdraw_invite" class="btn btn--white small-btn">Withdraw</button>
                                </form>
                            </td>
                        {% endif %}
                    </tr>
                {% empty %}
                    <tr><td colspan="5">No pending invites.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}