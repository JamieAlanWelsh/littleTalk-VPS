{% extends "base.html" %}
{% load static %}

{% block title %}Chatterdillo | Profile{% endblock %}

{% block content %}
<h1>Learner Profile</h1>
<div class="profile-container">
    <!-- Left Column -->
    <div class="left-column">

        {% if request.user.profile.role != 'parent' or learners|length <= 2 %}
            <div class="add-learner-btn">
                <a href="{% url 'add_learner' %}" class="button">+ Add Learner</a>
            </div>
        {% endif %}

        <div class="learners-list profile-card">
            {% if request.user.profile.role != 'parent' %}
                <div class="profile-card__header">
                    <h3 class="profile-card__title">Cohort:</h3>
                    <form method="get" action="" class="section-filter">
                        <select name="cohort" id="cohort" class="section-filter__select" onchange="this.form.submit()">
                            <option value="">All Cohorts</option>
                            {% for cohort in cohorts %}
                                <option value="{{ cohort.id }}" {% if cohort.id == selected_cohort %}selected{% endif %}>
                                    {{ cohort.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}
            {% if learners %}
                <ul>
                    {% for learner in learners %}
                        <li class="learner-item">
                            <form method="POST" action="{% url 'select_learner' %}">
                                {% csrf_token %}
                                <button type="submit" name="learner_id" value="{{ learner.id }}" 
                                        class="learner-button {% if learner.id == selected_learner.id %}selected{% endif %}">
                                    {{ learner.name }}
                                </button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    </div>

    <!-- Right Column -->
    <div class="right-column">
        <!-- Learning Level Section -->
        {% if selected_learner %}
            <!-- Total Experience Section -->
            <div class="profile-card profile-card--details">
                <div class="profile-card__header">
                    <h3 class="profile-card__title">Learner Details:</h3>
                </div>
                <p><strong>Name:</strong> {{ selected_learner.name }}</p>
            
                {% if selected_learner.cohort %}
                    <p><strong>Cohort:</strong> {{ selected_learner.cohort }}</p>
                {% endif %}
                {% if request.user.profile.role == 'parent' and selected_learner.school_id %}
                    <div class="recommendation-info mb-20">
                        <span class="info-icon">i</span>
                        <p>
                            Parent-Access - This learner is being managed by {{ selected_learner.school.name }}
                        </p>
                    </div>
                {% endif %}
            </div>

            <!-- Targets Section -->
            <div class="profile-card profile-card--targets profile-card--padded">
                <div class="profile-card__header">
                    <h3 class="profile-card__title">Targets:</h3>
                    <div class="section-filter">
                        <select id="targets-filter" class="section-filter__select">
                            <option value="all" selected>All Targets</option>
                            <option value="achieved">Achieved</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="not_achieved">Not Achieved</option>
                            <option value="---">----</option>
                        </select>
                    </div>
                </div>
                
                <div class="targets-container" id="targets-container">
                    {% if selected_learner.targets.all %}
                        {% for target in selected_learner.targets.all %}
                            <div class="target-card target-status-{{ target.status }}" data-target-id="{{ target.id }}" data-status="{{ target.status }}">
                                <div class="target-content">
                                    <span class="target-text">{{ target.text }}</span>
                                    <input
                                        type="text"
                                        class="target-text-input"
                                        data-target-id="{{ target.id }}"
                                        value="{{ target.text }}"
                                        maxlength="255"
                                        aria-label="Edit target"
                                    />
                                    <select class="target-status-dropdown" data-target-id="{{ target.id }}">
                                        <option value="---" {% if target.status == '---' %}selected{% endif %}>----</option>
                                        <option value="achieved" {% if target.status == 'achieved' %}selected{% endif %}>Achieved</option>
                                        <option value="not_achieved" {% if target.status == 'not_achieved' %}selected{% endif %}>Not Achieved</option>
                                        <option value="ongoing" {% if target.status == 'ongoing' %}selected{% endif %}>Ongoing</option>
                                    </select>
                                </div>
                                <button class="target-delete-btn" data-target-id="{{ target.id }}" title="Delete target">√ó</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-targets-message">No targets added yet.</p>
                    {% endif %}
                </div>

                <div class="targets-actions">
                    <button class="button-secondary" id="new-target-btn">+ New Target</button>
                    <button class="button-secondary" id="edit-targets-btn">Edit Targets</button>
                </div>
            </div>
            <!-- Edit Learner Button SCHOOL AND STANDALONE ONLY -->
            {% if request.user.profile.role != 'parent' or not selected_learner.school_id %}
                <div class="edit-learner-btn">
                    <a href="{% url 'edit_learner' selected_learner.learner_uuid %}" class="button">üìù Edit Learner</a>
                </div>
            {% endif %}

            <!-- Screener Button -->
            <div class="edit-learner-btn">
                <a href="{% url 'screener' %}" class="button">üìã Screener</a>
            </div>

            <!-- Generate Access Code Button SCHOOL ONLY -->
            {% if request.user.profile.role != 'parent' %}
                <div class="edit-learner-btn">
                    <a href="{% url 'view_parent_token' selected_learner.learner_uuid %}" class="button">üíå Parent Invite</a>
                </div>
            {% endif %}
        {% endif %}
        <!-- Susbcription details - PARENT ONLY -->
        <div class="profile-card profile-card--details">
            {% if request.user.profile.role == 'parent' %}
                <div class="edit-learner-btn">
                    <h3>Subscription</h3>
                    <p>
                        {% if is_subscribed %}
                            Active Parent Plan - 3 Learners
                        {% elif on_trial %}
                            Free Trial - {{ trial_days_left }} days left
                        {% else %}
                            Inactive
                        {% endif %}
                    </p>
                    <a href="{% url 'manage_subscription' %}" class="btn btn--white btn--small mb-20">Manage Subscription</a>
                </div>
            {% endif %}
        </div> 
    </div>
</div>

<!-- Pass learner UUID to JavaScript -->
{% if selected_learner %}
<script>
    window.currentLearnerUuid = '{{ selected_learner.learner_uuid }}';
</script>
{% endif %}

<script src="{% static 'js/targets_management.js' %}"></script>
{% endblock %}