{% extends "base.html" %}
{% load static %}

{% block title %}Assessment - LittleTalk{% endblock %}

{% block content %}

<h1>{{ question.topic }}</h1>

<form id="assessment-form" method="POST">
    {% csrf_token %}

    <div class="button-container">
        <h2 id="question-text">{{ question.text }}</h2>
        
        <button type="button" class="answer-button" data-value="Yes">Yes</button>
        <button type="button" class="answer-button" data-value="No">No</button>
    </div>

    <input type="hidden" name="answer" id="answer-input">
    <input type="hidden" name="question_id" value="{{ question.order }}">
    
    <!-- Back Button -->
    <button type="button" id="back-btn" class="back-button" style="display:none;">Back</button>
</form>

<div id="progress-bar-container">
    <progress id="progress-bar" max="100" value="{{ current_question_index|default_if_none:1 }}"></progress>
</div>

<script>
    const progressBar = document.getElementById('progress-bar');
    const totalQuestions = {{ total_questions }};
    let currentQuestionIndex = {{ current_question_index }};
    let currentQuestionId = {{ question.order }};
    let previousQuestionId = null;

    function updateProgressBar() {
        let percentage = (currentQuestionIndex / totalQuestions) * 100;
        progressBar.value = percentage;
    }

    // Initialize progress bar
    updateProgressBar();

    // Event listener for answer buttons
    document.querySelectorAll('.answer-button').forEach(button => {
        button.addEventListener('click', function () {
            const answer = this.getAttribute('data-value');
            const questionId = document.querySelector('[name="question_id"]').value;

            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('answer', answer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);

            fetch('/assessment/handle/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.next_question_id) {
                    document.getElementById('question-text').textContent = data.next_question_text;
                    document.querySelector('[name="question_id"]').value = data.next_question_id;

                    currentQuestionIndex++;
                    updateProgressBar();

                    previousQuestionId = data.previous_question_id;

                    if (previousQuestionId !== null) {
                        document.getElementById('back-btn').style.display = 'inline-block';
                    }

                } else {
                    window.location.href = "/assessment/summary/";
                }
            })
            .catch(error => console.log('Error:', error));
        });
    });

    // Back button logic
    document.getElementById('back-btn').addEventListener('click', function () {
        if (previousQuestionId !== null) {
            if (previousQuestionId - 1 === 0) {
                window.location.href = '/assessment/start/';
            } else {
                const formData = new FormData();
                formData.append('question_id', previousQuestionId - 1);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);

                fetch('/assessment/handle/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('question-text').textContent = data.next_question_text;
                    document.querySelector('[name="question_id"]').value = data.next_question_id;

                    currentQuestionIndex--;
                    updateProgressBar();

                    previousQuestionId = data.previous_question_id;

                    if (previousQuestionId === null) {
                        document.getElementById('back-btn').style.display = 'none';
                    }
                })
                .catch(error => console.log('Error:', error));
            }
        }
    });
</script>

{% endblock %}