{% extends "base.html" %}
{% load static %}

{% block title %}Assessment - LittleTalk{% endblock %}

{% block content %}

<h2 id="question-text">{{ question.text }}</h2>

<form id="assessment-form" method="POST">
    {% csrf_token %}
    
    <div class="radio-button-container">
        <label class="radio-option">
            <input type="radio" name="answer" value="Yes" class="answer-option" id="yes-button">
            <span class="radio-button">Yes</span>
        </label>
        <label class="radio-option">
            <input type="radio" name="answer" value="No" class="answer-option" id="no-button">
            <span class="radio-button">No</span>
        </label>
    </div>

    <input type="hidden" name="question_id" value="{{ question.order }}">
    
    <!-- Back Button -->
    <button type="button" id="back-btn" class="back-button" style="display:none;">Back</button>
</form>

<div id="progress-bar-container">
    <progress id="progress-bar" max="100" value="{{ current_question_index|default_if_none:1 }}"></progress>
</div>

<script>
    const progressBar = document.getElementById('progress-bar');
    const totalQuestions = {{ total_questions }};
    let currentQuestionIndex = {{ current_question_index }};
    let currentQuestionId = {{ question.order }};
    let previousQuestionId = null;
    
    function updateProgressBar() {
        let percentage = (currentQuestionIndex / totalQuestions) * 100;
        progressBar.value = percentage;
    }

    // Initialize progress bar
    updateProgressBar();

    // Event listener for radio button changes
    document.querySelectorAll('.answer-option').forEach(option => {
        option.addEventListener('change', function(event) {
            const answer = event.target.value;
            const questionId = document.querySelector('[name="question_id"]').value;

            // Send the answer immediately using AJAX
            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('answer', answer);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);

            // Send the form via AJAX to get the next question
            fetch('/assessment/handle/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.next_question_id) {
                    // Update the question text
                    document.getElementById('question-text').textContent = data.next_question_text;

                    // Update hidden input for the next question
                    document.querySelector('[name="question_id"]').value = data.next_question_id;

                    // Update progress bar
                    currentQuestionIndex++;
                    updateProgressBar();

                    // Set the previous question info
                    previousQuestionId = data.previous_question_id;

                    // Reset radio buttons (uncheck both)
                    const radioButtons = document.querySelectorAll('.answer-option');
                    radioButtons.forEach(button => button.checked = false);

                    // Show the Back button if there is a previous question
                    if (previousQuestionId !== null) {
                        document.getElementById('back-btn').style.display = 'inline-block';
                    }

                } else {
                    // End of the assessment, redirect to summary
                    window.location.href = "/assessment/summary/";
                }
            })
            .catch(error => console.log('Error:', error));
        });
    });

    // Back button logic
    document.getElementById('back-btn').addEventListener('click', function() {
        if (previousQuestionId !== null) {
            // Send a request to load the previous question
            const formData = new FormData();

            // If the user is at the first question (previousQuestionId == 1), restart the form
            if (previousQuestionId - 1 === 0) {
                // Restart the form (go back to the first question)
                window.location.href = '/assessment/start/';  // Redirect to the start of the assessment
            
            } else {

                formData.append('question_id', previousQuestionId - 1);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);

                // Send the form via AJAX to get the previous question
                fetch('/assessment/handle/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Update the question and progress bar with the previous question
                    document.getElementById('question-text').textContent = data.next_question_text;
                    document.querySelector('[name="question_id"]').value = data.next_question_id;
                    
                    // Update the progress bar
                    currentQuestionIndex--;
                    updateProgressBar();

                    // Reset radio buttons (uncheck both)
                    const radioButtons = document.querySelectorAll('.answer-option');
                    radioButtons.forEach(button => button.checked = false);

                    // Update the previous question ID
                    previousQuestionId = data.previous_question_id;

                    // If there's no previous question, hide the Back button
                    if (previousQuestionId === null) {
                        document.getElementById('back-btn').style.display = 'none';
                    }
                })
                .catch(error => console.log('Error:', error));
            }
        }
    });
</script>

{% endblock %}